---
title: "Gov 50 Final Project"
author: "William Tan"
description: "GOV50 Final Project"
output:
  distill::distill_article:
    self_contained: false
---
Introduction:

  The game of basketball is quickly becoming more complex. From the popularization of the three-point shot to advanced off-ball tactics, there's many aspects of basketball that make it difficult for a single team to dominate the NBA. Yet an age-old debate remains: is offense or defensive more important? I want to analyze whether points above average per 100 possessions added by a player on defense has a statistically significant and positive relationship with how many wins a player’s team accumulates during the season, and whether it is more or less significant than the number of points above average per 100 possessions added by a player on offense. In short, does defense serve as a legitimate metric and predictor of a team's success? To analyze this impact, I am using a data set that utilizes a sports metric system called RAPTOR. RAPTOR is a plus-minus statistic that measures the number of points a player contributes to his team’s offense and defense per 100 possessions, relative to a league-average player. In particular, my first explanatory variable of interest is the defense point statistics for that player, which is measured in points above average for 100 possessions. This is a variable called raptor_defense which utilizes a combination of plus-minus and box impact data. For context, plus−minus is a sports statistic used to measure a player's impact, represented by the difference between their team's total scoring versus their opponent's when the player is in the game. The second variable of interest is raptor_offense, which is the same as raptor_defense but for offensive points above average for 100 possessions.
  This project seeks to analyze the impact of defense versus the impact of offense on the number of wins a team receives through two sampling processes. The first will be a regression with both RAPTOR defense and offense on season wins for all players on all teams. This will be a data set-wide repression for all players on all teams. The second process will subset the process by team and will take the regression for both offensive and defensive point impact for each team, which will illuminate the causation of why the best teams did well in the season. In this sense, we can compare how offensive and defense impact season wins overall across all players and within specific teams, which will give sufficient data to to confirm or reject the central hypothesis: teams with a greater number of points above average per 100 possessions on defense over the course of the season will show higher positive rates of correlation with number of wins than teams with a greater number of points above average per 100 possessions on offense. 

Data:
```{r, fig.width = 10}
library(tidyverse)
library(infer)
raptor <- read.csv("latest_RAPTOR_by_team.csv")
raptor2 <- read.csv("latest_RAPTOR_by_team.csv")

```

```{r}
library(modelsummary)

pooled_reg_def <- lm(war_reg_season ~ raptor_defense, data = raptor2)
pooled_reg_off <- lm(war_reg_season ~ raptor_offense, data = raptor2)

modelsummary(pooled_reg_def, stars = c("*"=0.05,
                                       "**"=0.01,
                                       "***"=0.001))
modelsummary(pooled_reg_off, stars = c("*"=0.05,
                                       "**"=0.01,
                                       "***"=0.001))
# Get all unique team names
team_names <- unique(raptor2$team)[-1]

# Prepare empty data frame to store regression values for each team
output <- data.frame(matrix(ncol = 7, nrow = length(team_names)))

# Rename columns
names(output) <- c("team", "est.def", "se.def", "p.def",
                   "est.off", "se.off", "p.off")

# Initiate for loop, loop across all team names
for (i in 1:length(team_names)) {
  # Indicate which team we're looking at based on i value
  output$team[i] <- team_names[i]
  
  # Subset data down to certain team based on previous step
  raptor2_subset <- raptor2|>
  filter(team == team_names[i])
  
  # Conduct regression for defense and offense within team
  fit_1_intermediate <- lm(war_reg_season ~ raptor_defense, data = raptor2_subset)
  fit_2_intermediate <- lm(war_reg_season ~ raptor_offense, data = raptor2_subset)
  
  # Store values for each team
  output$est.def[i] <- summary(fit_1_intermediate)$coefficients[2,1]
  output$se.def[i] <- summary(fit_1_intermediate)$coefficients[2,2]
  output$p.def[i] <- summary(fit_1_intermediate)$coefficients[2,4]
  output$est.off[i] <- summary(fit_2_intermediate)$coefficients[2,1]
  output$se.off[i] <- summary(fit_2_intermediate)$coefficients[2,2]
  output$p.off[i] <- summary(fit_2_intermediate)$coefficients[2,4]
  
}

# Compute upper and lower bounds of CI using se * z-score +/- est
output <- output |>
  mutate(
    ci.lb.def = est.def - qnorm(0.975)*se.def,
    ci.ub.def = est.def + qnorm(0.975)*se.def,
    ci.lb.off = est.off - qnorm(0.975)*se.off,
    ci.ub.off = est.off + qnorm(0.975)*se.off,
  )

# Determine which coefficients are signifcant
output <- output |> 
  mutate(
    significance.def = as.factor(ifelse(p.def < 0.05, "yes", "no")),
    significance.off = as.factor(ifelse(p.off < 0.05, "yes", "no"))
  )


def_plot <- ggplot(aes(x = team, y = est.def), data = output) +
  geom_point(aes(color = significance.def)) + 
  geom_errorbar(aes(ymin = ci.lb.def, 
                    ymax = ci.ub.def, 
                    width = 0.2, color = significance.def)) +
  theme(axis.text.x = element_text(angle=90, hjust =1)) + 
  xlab("Team") + ylab("Coefficient on raptor_defense") +
  scale_color_manual(name = "Significant or not?", 
                     labels = c("no", "yes"), 
                     values = c("red", "forestgreen"))
def_plot

off_plot <- ggplot(aes(x = team, y = est.off), data = output) +
  geom_point(aes(color = significance.off)) + 
  geom_errorbar(aes(ymin = ci.lb.off, 
                    ymax = ci.ub.off, 
                    width = 0.2, color = significance.off)) +
  theme(axis.text.x = element_text(angle=90, hjust =1)) + 
  xlab("Team") + ylab("Coefficient on raptor_offense") +
  scale_color_manual(name = "Significant or not?", 
                     labels = c("no", "yes"), 
                     values = c("red", "forestgreen"))
off_plot
```


