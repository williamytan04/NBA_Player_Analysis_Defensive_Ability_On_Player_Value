---
title: "Gov 50 Final Project"
author: "William Tan"
description: "GOV50 Final Project"
output:
  distill::distill_article:
    self_contained: false
---
Introduction:

  The game of basketball is quickly becoming more complex. From the popularization of the three-point shot to advanced off-ball tactics, there's many aspects of basketball that make it difficult for a single team to dominate the NBA. Yet an age-old debate remains: is offense or defensive more important? I want to analyze whether points above average per 100 possessions added by a player on defense has a statistically significant relationship with how many wins a player’s team accumulates during the season and how it compares to the number of points above average per 100 possessions added by a player on offense. In short, does defense serve as a legitimate metric and predictor of a team's success? To analyze this impact, I am using a data set that utilizes a sports metric system called RAPTOR. RAPTOR is a plus-minus statistic that measures the number of points a player contributes to his team’s offense and defense per 100 possessions, relative to a league-average player. In particular, my first explanatory variable of interest is raptor_defense, which  utilizes a combination of plus-minus and box impact data to calculate the points above average for 100 possessions added by a player on defense. The second variable of interest is raptor_offense, which is the same as raptor_defense but for offensive points above average for 100 possessions. For context, plus−minus is a sports statistic used to measure a player's impact, represented by the difference between their team's total scoring versus their opponent's when the player is in the game. 
  To accomplish this analysis, I will analyze the impact of defense versus offense on the number of wins a team receives through two methods. The first will be a regression with for RAPTOR defense and offense on season wins for all players on all teams. The second process will group the process by team and will take the regression for both offensive and defensive point impact for each team, which will illuminate the inter-team effect. In this sense, we can compare how offensive and defense impact season wins overall across all players and within specific teams, which will give sufficient data to to confirm or reject the central hypothesis: teams with a greater number of points above average per 100 possessions on defense over the course of the season will show higher positive rates of correlation with number of wins than teams with a greater number of points above average per 100 possessions on offense. 

Results:
```{r, fig.width = 10}
library(tidyverse)
library(infer)
raptor <- read.csv("latest_RAPTOR_by_team.csv")
raptor2 <- read.csv("latest_RAPTOR_by_team.csv")

```

```{r}
library(modelsummary)

pooled_reg_def <- lm(war_reg_season ~ raptor_defense, data = raptor2)
pooled_reg_off <- lm(war_reg_season ~ raptor_offense, data = raptor2)

modelsummary(pooled_reg_def, stars = c("*"=0.05,
                                       "**"=0.01,
                                       "***"=0.001))
modelsummary(pooled_reg_off, stars = c("*"=0.05,
                                       "**"=0.01,
                                       "***"=0.001))
```
  Looking at the regression coefficient for raptor_defense across all teams and all players, we see that on average, an increase of one defensive point added above average for 100 possessions leads to a 0.052 increase in wins during a season. The intercept of 1.018 can be interpreted as the number of wins a team will receive when no defensive points are added above average for 100 possessions. The R2 value of 0.014 indicates that 1.4% percent of the variation in the [insert description of outcome variable] is explained by the variation in the model. The regression coefficient and intercept are both highly significant, as the p-value of less than 0.001 says that data this extreme would only happen in 0.1% of repeated samples if the null were true. In short, there is a high probability of rejecting the null, which means there is a high probability that there isn't no effect of defense on number of wins during a season for all players across all teams. 
   Looking at the regression coefficient for raptor_offense across all teams and all players, we see that on average, an increase of one offensive point added above average for 100 possessions leads to a 0.113 increase in wins during a season. The intercept of 1.186 can be interpreted as the number of wins a team will receive when no offensive points are added above average for 100 possessions. The R2 value of 0.014 indicates that 8.7% percent of the variation in the number of wins accrued is explained by the variation in the model. The regression coefficient and intercept are both highly significant, as the p-value of less than 0.001 says that data this extreme would only happen in 0.1% of repeated samples if the null were true. In short, there is a high probability of rejecting the null, which means there is a high probability that there isn't no effect of offense on number of wins during a season for all players across all teams. 

```{r}
# Get all unique team names
team_names <- unique(raptor2$team)[-1]

# Prepare empty data frame to store regression values for each team
output <- data.frame(matrix(ncol = 7, nrow = length(team_names)))

# Rename columns
names(output) <- c("team", "est.def", "se.def", "p.def",
                   "est.off", "se.off", "p.off")

# Initiate for loop, loop across all team names
for (i in 1:length(team_names)) {
  # Indicate which team we're looking at based on i value
  output$team[i] <- team_names[i]
  
  # Subset data down to certain team based on previous step
  raptor2_subset <- raptor2|>
  filter(team == team_names[i])
  
  # Conduct regression for defense and offense within team
  fit_1_intermediate <- lm(war_reg_season ~ raptor_defense, data = raptor2_subset)
  fit_2_intermediate <- lm(war_reg_season ~ raptor_offense, data = raptor2_subset)
  
  # Store values for each team
  output$est.def[i] <- summary(fit_1_intermediate)$coefficients[2,1]
  output$se.def[i] <- summary(fit_1_intermediate)$coefficients[2,2]
  output$p.def[i] <- summary(fit_1_intermediate)$coefficients[2,4]
  output$est.off[i] <- summary(fit_2_intermediate)$coefficients[2,1]
  output$se.off[i] <- summary(fit_2_intermediate)$coefficients[2,2]
  output$p.off[i] <- summary(fit_2_intermediate)$coefficients[2,4]
  
}

# Compute upper and lower bounds of CI using se * z-score +/- est
output <- output |>
  mutate(
    ci.lb.def = est.def - qnorm(0.975)*se.def,
    ci.ub.def = est.def + qnorm(0.975)*se.def,
    ci.lb.off = est.off - qnorm(0.975)*se.off,
    ci.ub.off = est.off + qnorm(0.975)*se.off,
  )

# Determine which coefficients are signifcant
output <- output |> 
  mutate(
    significance.def = as.factor(ifelse(p.def < 0.05, "yes", "no")),
    significance.off = as.factor(ifelse(p.off < 0.05, "yes", "no"))
  )


def_plot <- ggplot(aes(x = team, y = est.def), data = output) +
  geom_point(aes(color = significance.def)) + 
  geom_errorbar(aes(ymin = ci.lb.def, 
                    ymax = ci.ub.def, 
                    width = 0.2, color = significance.def)) +
  theme(axis.text.x = element_text(angle=90, hjust =1)) + 
  xlab("Team") + ylab("Coefficient on raptor_defense") +
  scale_color_manual(name = "Significant or not?", 
                     labels = c("no", "yes"), 
                     values = c("red", "forestgreen"))
def_plot

off_plot <- ggplot(aes(x = team, y = est.off), data = output) +
  geom_point(aes(color = significance.off)) + 
  geom_errorbar(aes(ymin = ci.lb.off, 
                    ymax = ci.ub.off, 
                    width = 0.2, color = significance.off)) +
  theme(axis.text.x = element_text(angle=90, hjust =1)) + 
  xlab("Team") + ylab("Coefficient on raptor_offense") +
  scale_color_manual(name = "Significant or not?", 
                     labels = c("no", "yes"), 
                     values = c("red", "forestgreen"))
off_plot
```
  The second regression model subsets the relationship between offense, defense, and number of wins to the players on each individual team. This will isolate the effect based on team which then can be compared to how the teams historically performed. Theoretically, teams that performed the best should have larger positive coefficients than those that did not. To accomplish this, I created an empty data frame to store the regression value, standard error, and p-value on raptor_offense and raptor_defense for each team. For the calculative process, I set up a for-loop that  took the regression for both variables. After, I algebraically found the upper and lower bounds for a 95% confidence interval using the formula: bound = sample mean +/- 1.96 * se. Finally, I created two plots for the spread of offense and defense, color-coded based on which teams reported statistically significant effects. 
  



